# Решите капчу за нас: WRITE-UP

## Как решать капчу?

В данном таске нас просили решать капчи. Собственно, начать стоит с того, как это делать.

Нам выдают картинку примерно такого вида:

![mukluk](captcha.png)

Под ней есть подпись «Следуйте радуге». Тут надо вспомнить порядок цветов в
радуге: красный, оранжевый и так далее. Но у нас могут возникать цвета, которых в радуге нет:

![waybill](captcha2.png)

Вспоминаем способы хранения цвета, один из них HSV (или HSL, неважно). В нем
есть компонента Hue, которая определяет тон. И действительно, если мы загуглим
что-то вроде «hue line», то там увеличение тона (hue) будет приводить к смене цветов в порядке радуги.
Таким образом, нам надо просто отсортировать буквы по тону.

Ответом на первую капчу будет `mukmul`, а на вторую — `waybill`.

## Что происходит дальше?
Мы вбиваем наш правильный ответ и получаем первые 4$. Радуемся, вбиваем ещё один
— но долларов появляется всего лишь два. Еще ответ — а доллар дали только один…
Затем идут 50 центов, 25 центов, а дальше и вовсе по центу за ответ.
Ясно, что так дело не пойдёт, и нужно как-то автоматизировать.

Примерно на этом же моменте мы ловим наш первый комплимент — «Вы чересчур
старательны». Так выглядит попадание в рейтлимитер. Оказывается, мы можем решать только по пять
капч в пять минут.

Нас такое, разумеется, тоже не устраивает — и мы смотрим на запросы. Там видно,
что сначала идет POST-запрос с ответом на url капчи, и оттуда приходит редирект на
главную и смена куки. Попробуем поотправлять запросы сами:

```python
sess = requests.Session()

for _ in range(500):
    sess.post(captcha_url, data={'answer': answer}).raise_for_status()

print(sess.get(home_url).text)
```

В процессе можем увидеть, что куки меняются.

Понимаем, что нам достаточно решить только одну капчу и мы можем её отправлять сколько угодно раз — доллары за успех продолжат начисляться. Мы снова утыкаемся в рейтлимит. Однако куки меняются с каждым запросом даже после рейтлимита.

Мы просто можем подождать пять минут и снова зайти на главную с новой кукой — и получить флаг.

> Есть и более простой путь: можно указать `allow_redirects=False`. Тогда рейтлимитер срабатывать не будет, так как он проверяет только заходы на главную страницу.

Флаг: **ugra_thanks_and_give_your_money_a7eb398b31bz**

## Постмортем

Многие участники видели рейтлимит сразу, при первом открытии главной страницы.
Проблема прояснилась только в момент написания райтапа:

```python
limiter = Limiter(
        lambda: session.get('token', 'nothing'),
        app=app,
        storage_uri='memcached://memcached:11211',
)
```

Поскольку просто так поменять куку ручками нельзя (сломается подпись), чтобы
одна и та же кука не подходила всем участникам, в нее был положен токен. Это
происходит при первом заходе на главную страницу. Но до этого срабатывает
рейтлимитер, который видит пустую куку, вернее, строку nothing — таким образом,
на всех вновь заходящих участников был один рейтлимит. И многим не везло,
они пытались зайти на страницу, когда другие пять человек уже забили лимит. И
приходилось ловить свою очередь, чтобы получить личную куку. При разработке
проблему не отловили, потому что не было пяти человек, которые пытались
решить таск одновременно.

> Однако, даже с этим при определённой доле везения можно было получить свою
> личную куку и решить задание.
