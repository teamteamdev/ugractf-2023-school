# Решите капчу за нас: WRITE-UP


## Как решать капчу?
В данном таске нас просили решать капчи. Собственно, начать стоит с того, как это делать.

Нам выдают картинку примерно такого вида:
![mukluk](captcha.png)

И под ней есть подпись "Следуйте радуге". Тут надо вспомнить порядок цветов в
радуге: красный, оранжевый и так далее. Но у нас могут цвета, которых нет в
радуге:
![waybill](captcha2.png)

Вспоминаем способы хранения цвета, один из них HSV (или HSL, неважно). В нем
есть компонента Hue, которая определяет тон. И действительно, если мы загуглим
что-то вроде "hue line", то там цвета радуги будут увеличиваться со значением
Hue. Таким образом, нам надо просто расставить буквы по порядку тона.

Ответом на первую капчу будет `mukmul`, а на вторую `waybill`.

## Что происходит дальше?
Мы вбиваем наш правильный ответ и получаем первые 4$. Радуемся, вбиваем еще один
--- всего лишь два. Еще один --- один дали... Затем 50 центов, 25 центов, а
дальше по одному. Ясно, что так дело не пойдет и нужно как-то автоматизировать.

Примерно на этом же моменте мы ловим наш первый комплимент "Вы черезчур
старательны". Попали в райтлимитер. Оказывается, мы можем решать только по пять
капч в пять минут.

Нас такое, разумеется, тоже не устраивает и мы смотрим на запросы. Там видно,
что сначала идет POST запрос с ответом на url капчи, оттуда редирект на
главную + смена куки. Попробуем отправлять запросы сами:

```python
sess = requests.Session()

for _ in range(500):
    sess.post(captcha_url, data={'answer': answer}).raise_for_status()

print(sess.get(home_url).text)
```

Мы снова видим райтлимит. Однако, если посмотреть на куки, то они будут меняться
с каждым запросом. Тогда мы просто подождем пять минут и снова зайдем на главную
с новой кукой. И получим наш флаг.

> Так оно должно решаться, но есть более простой путь: можно указать
> `allow_redirects=False` и тогда райтлимитер не будет стрелять, так как он
> только на главной.

То есть нам нужно решить только одну капчу и мы можем ее отправлять сколь угодно
раз, при этом не быть пойманным райтлимитером.

Флаг: **ugra_thanks_and_give_your_money_a7eb398b31bz**

# Postmortem
У многих был райтлимит при первом открытии главной страницы. Казалось бы, довольно странно, но проблема выяснилась только в момент написания райтапа:

```python
limiter = Limiter(
        lambda: session.get('token', 'nothing'),
        app=app,
        storage_uri='memcached://memcached:11211',
)
```

Поскольку просто так поменять куку ручками нельзя (сломается подпись), чтобы
одна и та же кука не подходила всем участникам в нее был положен токен. Это
происходит при первом заходе на главную страницу. Но до этого срабатывает
райтлимитер, а к нему приходит пустая кука. Как видно по коду выше, он всех
считает ничем, а значит райтлимит был для всех общий. И многим из вас не везло,
они пытались зайти на таск, когда другие пять человек уже забили лимит. И вам
приходилось ловить свою очередь, чтобы получить личную куку. При разработке
такую проблему не отловили, потому что не было пяти человек, которые пытались
решить таск одновременно.

> Однако, даже с этим при определенной доле везения можно было получить свою
> личную куку и решить таск.
